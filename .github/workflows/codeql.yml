# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL Analyze"

on:
  ## CodeQL If using "Default Setup", remove custom workflows. üöÄ
  # schedule:
  #   ## run every Wednesday at 6am UTC
  #   - cron: '0 6 * * 1'
  # push:
  #   branches: [ "main", "*.X" ]
  # pull_request:
  #   branches: [ "main", "*.X" ]
  workflow_dispatch:

permissions:
  # only required for workflows in private repositories
  contents: read  # for actions/checkout to fetch code
  actions: read  # for github/codeql-action/init to get workflow details
  # required for all workflows
  packages: read  # required to fetch internal or private CodeQL packs
  security-events: write  # for github/codeql-action/autobuild to send a status report

# simultaneity
concurrency:
  ## The group key defines how GitHub Actions groups workflow runs together.
  ## github.workflow ‚Üí The name of the workflow file.
  ## github.ref      ‚Üí The branch or tag the workflow is running on.
  group: ${{ github.workflow }}-${{ github.ref }}
  ## If you push multiple times quickly, older runs would continue even though newer ones have started.
  ## Canceling previous runs reduces resource usage and speeds up feedback.
  cancel-in-progress: true

jobs:
  analyze:
    name: CodeQL Analyze (${{ matrix.language }})
    # Runner size impacts CodeQL analysis time. To learn more, please see:
    #   - https://gh.io/recommended-hardware-resources-for-running-codeql
    #   - https://gh.io/supported-runners-and-hardware-resources
    #   - https://gh.io/using-larger-runners (GitHub.com only)
    # Consider using larger runners or machines with greater resources for possible analysis time improvements.
    runs-on: ${{ 'ubuntu-latest' || (matrix.language == 'swift' && 'macos-latest') }}
    # timeout-minutes: 360

    permissions:
      # only required for workflows in private repositories
      contents: read  # for actions/checkout to fetch code
      actions: read  # for github/codeql-action/init to get workflow details
      # required for all workflows
      packages: read  # required to fetch internal or private CodeQL packs
      security-events: write  # for github/codeql-action/autobuild to send a status report

    strategy:
      fail-fast: false
      matrix:
        # CodeQL supports [ 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby' ]
        # Learn more about CodeQL language support at https://git.io/codeql-language-support
        language: [ 'python', 'c-cpp', 'javascript-typescript', 'actions', ]
        # include:
        # - language: python
        #   build-mode: none
        # - language: c-cpp
        #   build-mode: autobuild
        # - language: actions
        #   build-mode: none
        # If the analyze step fails for one of the languages you are analyzing with
        # "We were unable to automatically build your code", modify the matrix above
        # to set the build mode to "manual" for that language. Then modify this step
        # to build your code.
        # CodeQL supports the following values keywords for 'language': 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'swift'
        # Use `c-cpp` to analyze code written in C, C++ or both
        # Use 'java-kotlin' to analyze code written in Java, Kotlin or both
        # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both
        # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,
        # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.
        # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how
        # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages

    steps:
      - name: Checkout (cloned) repository with full history
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false  # Prevents accidental credential exposure
          submodules: true  # Fetch Hugo themes (true OR recursive)
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

      # Initializes the CodeQL tools for scanning.
      - name: CodeQL Initialize
        uses: github/codeql-action/init@5618c9fc1e675841ca52c1c6b1304f5255a905a0  # codeql-bundle-v2.19.0
        with:
          languages: ${{ matrix.language }}
          # build-mode: ${{ matrix.build-mode }}
          # source-root: src
          # If you wish to specify custom queries, you can do so here or in a config file.
          # By default, queries listed here will override any specified in a config file.
          # Prefix the list here with "+" to use these queries and those in the config file.
          # queries: ./path/to/local/query, your-org/your-repo/queries@main
          # For more details on CodeQL's query packs, refer to:
          # https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
          # queries: security-extended,security-and-quality

      # Autobuild attempts to build any compiled languages (C/C++, C#, Go, Java, or Swift).
      # If this step fails, then you should remove it and run the build manually (see below)
      - name: CodeQL Autobuild
        if: matrix.language != 'c-cpp'
        uses: github/codeql-action/autobuild@5618c9fc1e675841ca52c1c6b1304f5255a905a0  # codeql-bundle-v2.19.0

      # ‚ÑπÔ∏è Command-line programs to run using the OS shell.
      # üìö See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun
      # üìö https://git.io/JvXDl
      # ‚úèÔ∏è If the Autobuild fails above, remove it and uncomment the following three lines
      #    and modify them (or add more) to build your code if your project
      #    uses a compiled language, please refer to the EXAMPLE below for guidance.
      # - run: |
      #     echo "Run, Build Application using script"
      #     ./location_of_script_within_repo/buildscript.sh
      # - if: matrix.build-mode == 'manual'
      #   shell: bash
      #   run: |
      #     echo 'If you are using a "manual" build mode for one or more of the' \
      #       'languages you are analyzing, replace this with the commands to build' \
      #       'your code, for example:'
      #     echo '  make bootstrap'
      #     echo '  make release'
      #     exit 1

      - name: Manual Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v5.4.0
        if: matrix.language == 'c-cpp'
        with:
          python-version: '3.11'

      - name: Manual Build Library
        if: matrix.language == 'c-cpp'
        run: |
          pip install -r requirements/all.txt
          pip install --no-build-isolation --no-cache-dir -e .[dev,build,test,docs] -v

      - name: CodeQL Perform Analysis
        uses: github/codeql-action/analyze@5618c9fc1e675841ca52c1c6b1304f5255a905a0  # codeql-bundle-v2.19.0
        with:
          category: "/language:${{matrix.language}}"
